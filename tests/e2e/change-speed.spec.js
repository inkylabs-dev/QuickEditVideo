import { test, expect } from '@playwright/test';
import { statSync } from 'fs';

test.describe('Change Speed page - E2E', () => {
  test('should load change-speed page successfully', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Check that the page loads with correct title
    await expect(page).toHaveTitle(/Video Speed Changer - Speed Up & Slow Down Videos Online Free/);
    
    // Check basic page structure
    await expect(page.locator('h1')).toContainText('Video Speed Changer');
    await expect(page.locator('text=Select your video')).toBeVisible({ timeout: 10000 });
  });

  test('should change video speed and download file', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Wait for the component to load
    await page.waitForSelector('text=Select your video', { timeout: 10000 });
    
    // Upload the test video file
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for video to load and interface to change
    await page.waitForSelector('video', { timeout: 15000 });
    
    // Wait for FFmpeg to load (indicated by download button being enabled)
    await page.waitForSelector('button:has-text("Download"):not([disabled])', { timeout: 30000 });
    
    // Check that speed control interface is displayed
    await expect(page.locator('text=Speed Controls')).toBeVisible();
    await expect(page.locator('text=Speed: 1x')).toBeVisible();
    
    // Check that speed slider is present
    const speedSlider = page.locator('input[type="range"]');
    await expect(speedSlider).toBeVisible();
    await expect(speedSlider).toHaveAttribute('min', '0.25');
    await expect(speedSlider).toHaveAttribute('max', '4');
    
    // Change speed to 2x using slider
    await speedSlider.fill('2');
    await expect(page.locator('text=Speed: 2x')).toBeVisible();
    
    // Check that download button text updates
    await expect(page.locator('button:has-text("Download 2x Speed Video")')).toBeVisible();
    
    // Set up download listener
    const downloadPromise = page.waitForEvent('download');
    
    // Click download button
    await page.click('button:has-text("Download 2x Speed Video")');
    
    // Wait for download
    const download = await downloadPromise;
    
    // Verify download started
    expect(download.suggestedFilename()).toMatch(/.*_2x_fast\.mp4$/);
    
    // Save the download to verify it exists
    const downloadPath = `tests/e2e/downloads/${download.suggestedFilename()}`;
    await download.saveAs(downloadPath);
    
    // Verify file was created and has content
    const stats = statSync(downloadPath);
    expect(stats.size).toBeGreaterThan(0);
  });

  test('should show speed presets and allow selection', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Check that speed presets are displayed
    const presets = ['0.25x', '0.5x', '0.75x', '1x', '1.25x', '1.5x', '2x', '3x', '4x'];
    
    for (const preset of presets) {
      await expect(page.locator(`button:has-text("${preset}")`)).toBeVisible();
    }
    
    // Click on 0.5x preset
    await page.click('button:has-text("0.5x")');
    await expect(page.locator('text=Speed: 0.5x')).toBeVisible();
    
    // Click on 4x preset
    await page.click('button:has-text("4x")');
    await expect(page.locator('text=Speed: 4x')).toBeVisible();
  });

  test('should show interpolation option for slow speeds', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Initially at 1x speed, interpolation should not be visible
    await expect(page.locator('text=Use motion interpolation')).not.toBeVisible();
    
    // Change to slow speed (0.5x)
    await page.click('button:has-text("0.5x")');
    
    // Interpolation option should now be visible
    await expect(page.locator('text=Use motion interpolation')).toBeVisible();
    
    // Check that interpolation checkbox is present and unchecked
    const interpolationCheckbox = page.locator('input[type="checkbox"]');
    await expect(interpolationCheckbox).toBeVisible();
    await expect(interpolationCheckbox).not.toBeChecked();
    
    // Toggle interpolation
    await interpolationCheckbox.check();
    await expect(interpolationCheckbox).toBeChecked();
    
    // Change to fast speed (2x) - interpolation should disappear
    await page.click('button:has-text("2x")');
    await expect(page.locator('text=Use motion interpolation')).not.toBeVisible();
  });

  test('should show correct final duration based on speed', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // At 1x speed, should show original duration (5 seconds for colors.mp4)
    await expect(page.locator('text=1x speed')).toBeVisible();
    await expect(page.locator('text=00:05 final duration')).toBeVisible();
    
    // Change to 2x speed - duration should halve
    await page.click('button:has-text("2x")');
    await expect(page.locator('text=2x speed')).toBeVisible();
    await expect(page.locator('text=00:02 final duration')).toBeVisible();
    
    // Change to 0.5x speed - duration should double
    await page.click('button:has-text("0.5x")');
    await expect(page.locator('text=0.5x speed')).toBeVisible();
    await expect(page.locator('text=00:10 final duration')).toBeVisible();
  });

  test('should allow play/pause preview', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Check play button is visible
    await expect(page.locator('button:has-text("Play Preview")')).toBeVisible();
    
    // Click play button
    await page.click('button:has-text("Play Preview")');
    
    // Button should change to pause
    await expect(page.locator('button:has-text("Pause Preview")')).toBeVisible();
    
    // Click pause button
    await page.click('button:has-text("Pause Preview")');
    
    // Button should change back to play
    await expect(page.locator('button:has-text("Play Preview")')).toBeVisible();
  });

  test('should reset speed to 1x when reset button is clicked', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Change speed to 2x
    await page.click('button:has-text("2x")');
    await expect(page.locator('text=Speed: 2x')).toBeVisible();
    
    // Click reset button
    await page.click('button[title="Reset to normal speed"]');
    
    // Speed should be back to 1x
    await expect(page.locator('text=Speed: 1x')).toBeVisible();
  });

  test('should return to landing view when close button is clicked', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Click close button
    await page.click('button[title="Choose different video"]');
    
    // Should return to landing view
    await expect(page.locator('text=Select your video')).toBeVisible();
  });

  test('should handle different video formats', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Test with WebM format if available, otherwise skip
    try {
      const fileInput = page.locator('input[type="file"]');
      await fileInput.setInputFiles('tests/e2e/static/colors.webm');
      
      // Wait for interface to load
      await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
      
      // Check that filename is displayed
      await expect(page.locator('text=colors.webm')).toBeVisible();
      
      // Change speed and verify download button updates
      await page.click('button:has-text("2x")');
      await expect(page.locator('button:has-text("Download 2x Speed Video")')).toBeVisible();
      
    } catch (error) {
      // If WebM test file doesn't exist, that's okay for this test
      console.log('WebM test file not available, skipping format test');
    }
  });

  test('should show loading state initially', async ({ page }) => {
    await page.goto('/change-speed');
    
    // Upload test video
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/e2e/static/colors.mp4');
    
    // Wait for interface to load
    await page.waitForSelector('text=Speed Controls', { timeout: 15000 });
    
    // Initially, FFmpeg might be loading
    // The download button should eventually become enabled
    await page.waitForSelector('button:has-text("Download"):not([disabled])', { timeout: 30000 });
  });
});